import DeviceModel from "./device.model.js";

export default class DevicesService {
  findAllDevices() {
    return DeviceModel.find();
  }

  findDeviceById(id) {
    return DeviceModel.findById(id);
  }

  async updateDevices(devices) {
    const docs = await DeviceModel.find({ _id: { $in: devices.map((d) => d._id) } });

    return Promise.all(
      docs.map((doc) => {
        doc.quantity -= devices.find((d) => d._id === doc._id.toString()).count;
        return doc.save().catch(() => ({}));
      })
    ).then((res) => {
      return res
        .filter((el) => el._id)
        .map((el) => {
          el = JSON.parse(JSON.stringify(el));
          el.decreasedBy = devices.find((d) => el._id === d._id).count;
          return el;
        });
    });
  }
}
